# SPDX-License-Identifier: MPL-2.0-or-later
# Primary CI/CD - GitLab is the source of truth

stages:
  - security
  - lint
  - test
  - build

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/
    - target/

# ==================
# Security Scanning
# ==================

trivy:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy fs --exit-code 0 --severity HIGH,CRITICAL --format table .
    - trivy fs --exit-code 1 --severity CRITICAL .
  allow_failure: false

gitleaks:
  stage: security
  image: zricethezav/gitleaks:latest
  script:
    - gitleaks detect --source . --verbose --redact
  allow_failure: false

semgrep:
  stage: security
  image: returntocorp/semgrep
  script:
    - semgrep --config auto --error .
  allow_failure: true

cargo-audit:
  stage: security
  image: rust:latest
  script:
    - cargo install cargo-audit
    - cd src/rust && cargo audit
  rules:
    - exists:
        - src/rust/Cargo.toml

cargo-deny:
  stage: security
  image: rust:latest
  script:
    - cargo install cargo-deny
    - cd src/rust && cargo deny check
  rules:
    - exists:
        - src/rust/Cargo.toml
  allow_failure: true

mix-audit:
  stage: security
  image: elixir:latest
  script:
    - cd src/elixir
    - mix local.hex --force
    - mix archive.install hex mix_audit --force
    - mix deps.get
    - mix deps.audit
  rules:
    - exists:
        - src/elixir/mix.exs
  allow_failure: true

# ==================
# Linting
# ==================

rustfmt:
  stage: lint
  image: rust:latest
  script:
    - rustup component add rustfmt
    - cd src/rust && cargo fmt -- --check
  rules:
    - exists:
        - src/rust/Cargo.toml

clippy:
  stage: lint
  image: rust:latest
  before_script:
    - export SKIP_SPARK_VERIFY=1
  script:
    - rustup component add clippy
    - cd src/rust && cargo clippy -- -D warnings
  rules:
    - exists:
        - src/rust/Cargo.toml
  allow_failure: true

mix-format:
  stage: lint
  image: elixir:latest
  script:
    - cd src/elixir && mix format --check-formatted
  rules:
    - exists:
        - src/elixir/mix.exs

credo:
  stage: lint
  image: elixir:latest
  script:
    - cd src/elixir
    - mix local.hex --force
    - mix deps.get
    - mix credo --strict
  rules:
    - exists:
        - src/elixir/mix.exs
  allow_failure: true

# ==================
# Testing
# ==================

cargo-test:
  stage: test
  image: rust:latest
  before_script:
    - export SKIP_SPARK_VERIFY=1
  script:
    - cd src/rust && cargo test --all-features
  rules:
    - exists:
        - src/rust/Cargo.toml

mix-test:
  stage: test
  image: elixir:latest
  script:
    - cd src/elixir
    - mix local.hex --force
    - mix deps.get
    - mix test
  rules:
    - exists:
        - src/elixir/mix.exs

# ==================
# Idris2 Type Checking
# ==================

idris2-check:
  stage: test
  image: snazzybucket/idris2:latest
  script:
    - cd src/idris2
    - idris2 --check Container.idr
    - idris2 --check Verification.idr
    - idris2 --check Attestation.idr
    - idris2 --check Main.idr
  rules:
    - exists:
        - src/idris2/*.idr
  allow_failure: true  # Until Idris2 toolchain is stable in CI

idris2-build:
  stage: build
  image: snazzybucket/idris2:latest
  script:
    - cd src/idris2
    - idris2 --build vordr.ipkg
  artifacts:
    paths:
      - src/idris2/build/
    expire_in: 1 week
  rules:
    - exists:
        - src/idris2/vordr.ipkg
  allow_failure: true

# ==================
# Ada/SPARK
# ==================

ada-build:
  stage: build
  image: tomberek/gnat:latest
  script:
    - cd src/ada
    - gprbuild -P policy.gpr
  rules:
    - exists:
        - src/ada/*.gpr
  allow_failure: true

spark-prove:
  stage: test
  image: tomberek/gnat:latest
  script:
    - cd src/ada
    - gnatprove -P policy.gpr --level=2
  rules:
    - exists:
        - src/ada/*.gpr
  allow_failure: true  # SPARK proofs are aspirational for now

# ==================
# Build
# ==================

cargo-build:
  stage: build
  image: rust:latest
  before_script:
    - export SKIP_SPARK_VERIFY=1
  script:
    - cd src/rust && cargo build --release
  artifacts:
    paths:
      - src/rust/target/release/vordr
    expire_in: 1 week
  rules:
    - exists:
        - src/rust/Cargo.toml

mix-build:
  stage: build
  image: elixir:latest
  script:
    - cd src/elixir
    - mix local.hex --force
    - mix deps.get
    - MIX_ENV=prod mix compile
  rules:
    - exists:
        - src/elixir/mix.exs

# ==================
# MCP Adapter (ReScript)
# ==================

mcp-build:
  stage: build
  image: denoland/deno:latest
  script:
    - cd src/mcp-adapter
    # ReScript compilation
    - npx rescript
  artifacts:
    paths:
      - src/mcp-adapter/src/*.res.js
    expire_in: 1 week
  rules:
    - exists:
        - src/mcp-adapter/rescript.json
  allow_failure: true

# ==================
# Mustfile Verification
# ==================

must-checks:
  stage: test
  image: ubuntu:latest
  script:
    - apt-get update && apt-get install -y make findutils grep
    - make -f Mustfile must-language-policy
    - make -f Mustfile must-security
    - make -f Mustfile must-rsr
  allow_failure: false
