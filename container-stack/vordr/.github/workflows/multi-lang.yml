# SPDX-License-Identifier: MPL-2.0-or-later
name: Multi-Language Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: read-all

jobs:
  idris2-build:
    name: Build Idris2 Components
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install Idris2
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme
          git clone https://github.com/idris-lang/Idris2.git /tmp/idris2
          cd /tmp/idris2
          make bootstrap SCHEME=scheme
          make install

      - name: Build Idris2 state machine
        run: |
          cd src/idris2
          idris2 --build vordr.ipkg

      - name: Run Idris2 tests
        run: |
          cd src/idris2
          idris2 --test vordr.ipkg || true  # Allow failure until tests are complete

  rust-build:
    name: Build Rust Components
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@23bce251a8cd2ffc3c1075eaa2367cf899916d84 # v2
        with:
          workspaces: src/rust

      - name: Build Rust binary
        run: |
          cd src/rust
          SKIP_SPARK_VERIFY=1 cargo build --release

      - name: Run Rust tests
        run: |
          cd src/rust
          SKIP_SPARK_VERIFY=1 cargo test

      - name: Upload Rust binary
        uses: actions/upload-artifact@v4
        with:
          name: vordr-bin
          path: src/rust/target/release/vordr

  elixir-build:
    name: Build Elixir Orchestrator
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install Elixir
        uses: erlef/setup-beam@2f0a87e93ca409eeedb26db267e893c6b62d5c4c # v1.18
        with:
          elixir-version: '1.16'
          otp-version: '26.2'

      - name: Install dependencies
        run: |
          cd src/elixir
          mix local.hex --force
          mix local.rebar --force
          mix deps.get

      - name: Compile
        run: |
          cd src/elixir
          mix compile

      - name: Run tests
        run: |
          cd src/elixir
          mix test

      - name: Check formatting
        run: |
          cd src/elixir
          mix format --check-formatted

      - name: Run Dialyzer
        run: |
          cd src/elixir
          mix dialyzer

  ada-gatekeeper:
    name: Build Ada Gatekeeper
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install GNAT
        run: |
          sudo apt-get update
          sudo apt-get install -y gnat gprbuild gnatprove

      - name: Build Ada policy engine
        run: |
          cd src/ada
          gprbuild -P policy.gpr -j0 || true  # Allow failure if GNAT not fully installed

      - name: Run SPARK proofs
        run: |
          cd src/ada
          gnatprove -P policy.gpr --level=2 || true  # Allow failure, proofs are aspirational

      - name: Upload policy library
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: vordr-policy
          path: src/ada/lib/
