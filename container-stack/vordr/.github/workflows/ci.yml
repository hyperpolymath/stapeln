# SPDX-License-Identifier: MPL-2.0-or-later
# Vordr CI - Comprehensive build, lint, and test workflow
# Tests Rust, Elixir, and Ada/SPARK components

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  MIX_ENV: test

jobs:
  # ===========================================================================
  # Rust CI
  # ===========================================================================
  rust-check:
    name: Rust Check & Clippy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/rust
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: src/rust -> target
          cache-on-failure: true

      - name: Run cargo check
        run: cargo check --all-features --all-targets

      - name: Run clippy
        run: cargo clippy --all-features --all-targets -- -D warnings

  rust-fmt:
    name: Rust Format
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/rust
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    needs: [rust-check, rust-fmt]
    defaults:
      run:
        working-directory: src/rust
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: src/rust -> target
          cache-on-failure: true

      - name: Run tests
        run: cargo test --all-features

  rust-build-release:
    name: Rust Release Build
    runs-on: ${{ matrix.os }}
    needs: rust-test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: vordr
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: vordr-musl
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: vordr-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: vordr-macos-aarch64
    defaults:
      run:
        working-directory: src/rust
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl-tools (Linux musl)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: src/rust -> target
          cache-on-failure: true
          key: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: ${{ matrix.artifact }}
          path: src/rust/target/${{ matrix.target }}/release/vordr
          if-no-files-found: error

  # ===========================================================================
  # Elixir CI
  # ===========================================================================
  elixir-check:
    name: Elixir Format & Credo
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/elixir
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Elixir
        uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        with:
          elixir-version: '1.16'
          otp-version: '26'

      - name: Restore dependencies cache
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: |
            src/elixir/deps
            src/elixir/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('src/elixir/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Check formatting
        run: mix format --check-formatted

      - name: Run Credo (static analysis)
        run: mix credo --strict

  elixir-dialyzer:
    name: Elixir Dialyzer
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/elixir
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Elixir
        uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        with:
          elixir-version: '1.16'
          otp-version: '26'

      - name: Restore dependencies cache
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: |
            src/elixir/deps
            src/elixir/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('src/elixir/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-

      - name: Restore PLT cache
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        id: plt_cache
        with:
          path: src/elixir/priv/plts
          key: ${{ runner.os }}-plt-${{ hashFiles('src/elixir/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-plt-

      - name: Install dependencies
        run: mix deps.get

      - name: Create PLTs directory
        run: mkdir -p priv/plts

      - name: Run Dialyzer
        run: mix dialyzer --format github

  elixir-test:
    name: Elixir Tests
    runs-on: ubuntu-latest
    needs: elixir-check
    defaults:
      run:
        working-directory: src/elixir
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Elixir
        uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        with:
          elixir-version: '1.16'
          otp-version: '26'

      - name: Restore dependencies cache
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: |
            src/elixir/deps
            src/elixir/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('src/elixir/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Compile in test mode
        run: mix compile --warnings-as-errors

      - name: Run tests
        run: mix test --cover

  elixir-build-release:
    name: Elixir Release Build
    runs-on: ubuntu-latest
    needs: elixir-test
    defaults:
      run:
        working-directory: src/elixir
    env:
      MIX_ENV: prod
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Elixir
        uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        with:
          elixir-version: '1.16'
          otp-version: '26'

      - name: Restore dependencies cache
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: |
            src/elixir/deps
            src/elixir/_build
          key: ${{ runner.os }}-mix-prod-${{ hashFiles('src/elixir/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-prod-

      - name: Install dependencies
        run: mix deps.get --only prod

      - name: Compile production release
        run: mix compile

      # Note: Uncomment when release configuration is added to mix.exs
      # - name: Build release
      #   run: mix release
      #
      # - name: Upload release artifact
      #   uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      #   with:
      #     name: vordr-elixir-release
      #     path: src/elixir/_build/prod/rel/vordr
      #     if-no-files-found: error

  # ===========================================================================
  # Ada/SPARK CI (Optional - runs only if Ada source exists)
  # ===========================================================================
  ada-check:
    name: Ada/SPARK Build & Prove
    runs-on: ubuntu-latest
    # Only run if Ada files exist
    if: ${{ hashFiles('src/ada/src/*.ads') != '' }}
    defaults:
      run:
        working-directory: src/ada
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Alire
        uses: alire-project/setup-alire@d9a7d83af8b7bba85a10d2e65cbc8b0f66a4ba4e # v3.0.2

      - name: Build with gprbuild
        run: |
          if [ -f "alire.toml" ]; then
            alr build
          else
            gprbuild -P policy.gpr -XBUILD_MODE=Release
          fi

      - name: Run GNATprove (SPARK verification)
        run: |
          if command -v gnatprove &> /dev/null; then
            gnatprove -P policy.gpr --level=2 --report=all
          else
            echo "GNATprove not available, skipping SPARK verification"
          fi
        continue-on-error: true

  # ===========================================================================
  # Integration Summary
  # ===========================================================================
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs:
      - rust-build-release
      - elixir-build-release
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.rust-build-release.result }}" != "success" ]; then
            echo "Rust build failed"
            exit 1
          fi
          if [ "${{ needs.elixir-build-release.result }}" != "success" ]; then
            echo "Elixir build failed"
            exit 1
          fi
          echo "All CI checks passed!"
