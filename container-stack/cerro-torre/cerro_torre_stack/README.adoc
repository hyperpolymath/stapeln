= Cerro Torre Stack
:toc:
:toclevels: 3

Umbrella application for the Cerro Torre container security ecosystem.

== Architecture: Snap-In Services

This umbrella provides **three deployment modes** for maximum flexibility:

[cols="1,2,2,2"]
|===
| Mode | Latency | Use Case | Configuration

| *Separate*
| ~1-5ms
| Default, different machines, microservices
| Services run independently, communicate via HTTP/MCP

| *Snapped*
| ~1μs (1000× faster!)
| Single machine, maximum performance
| Services compiled together, direct function calls

| *Distributed*
| ~0.1-1ms
| Multi-node Erlang cluster
| Services on different nodes, Erlang RPC
|===

**Key Innovation:** Mode selection is automatic at compile-time. No configuration needed!

== Project Structure

[source]
----
cerro_torre_stack/
├── apps/
│   ├── cerro_shared/     # Shared types (ContainerTypes, MCPTypes)
│   ├── svalinn/          # Edge gateway (Phoenix HTTP API)
│   └── vordr/            # Container runtime (coming soon)
├── config/
│   ├── config.exs        # Compile-time config
│   └── runtime.exs       # Runtime config (ports, endpoints)
└── mix.exs               # Umbrella coordinator
----

== Apps Overview

=== cerro_shared

Shared type definitions preventing impedance mismatch:

* `ContainerTypes` - Container info, state, verification results
* `MCPTypes` - JSON-RPC 2.0 protocol helpers

=== svalinn

Phoenix-based edge gateway providing HTTP API for container operations.

**Endpoints:**

[source,bash]
----
# Health checks (no auth)
GET  /health              # Service health + Vörðr connection status
GET  /ready               # Readiness probe
GET  /adapter             # Shows current deployment mode

# Container API (v1)
GET    /api/v1/containers           # List all containers
GET    /api/v1/containers/:id       # Get container details
POST   /api/v1/containers           # Create container
DELETE /api/v1/containers/:id       # Stop and remove container

# Image verification
POST   /api/v1/verify               # Verify image signature + SBOM
----

**VordrAdapter:** The core snap-in mechanism. Uses compile-time detection:

[source,elixir]
----
if Code.ensure_loaded?(Vordr.Container) do
  # SNAPPED MODE - Direct function calls
  def create_container(image, opts) do
    Vordr.Container.create(image, opts)
  end
else
  # SEPARATE MODE - HTTP/MCP JSON-RPC
  def create_container(image, opts) do
    mcp_call("vordr_container_create", %{image: image, ...})
  end
end
----

== Quick Start

=== Mode 1: Separate (Default)

Run Svalinn alone, point it at remote Vörðr:

[source,bash]
----
# Terminal 1: Start Vörðr (assuming it's running on localhost:8080)
cd ~/Documents/hyperpolymath-repos/vordr
mix phx.server

# Terminal 2: Start Svalinn
cd ~/Documents/hyperpolymath-repos/cerro_torre_stack
export VORDR_ENDPOINT=http://localhost:8080
mix phx.server --prefix svalinn

# Test
curl http://localhost:8000/health
# Shows: "vordr_mode": "separate"
----

=== Mode 2: Snapped (1000× Faster!)

Add Vörðr to umbrella and compile together:

[source,bash]
----
# 1. Move Vörðr into umbrella (one-time setup)
cd ~/Documents/hyperpolymath-repos/cerro_torre_stack/apps
ln -s ../../vordr vordr  # Symlink existing Vörðr
# Or: git clone your-vordr-repo vordr

# 2. Update cerro_torre_stack/mix.exs
# (Add :vordr to applications list if not auto-detected)

# 3. Compile - VordrAdapter automatically detects Vörðr!
mix deps.get
mix compile

# 4. Start (both apps in one VM)
mix phx.server

# Test
curl http://localhost:8000/health
# Shows: "vordr_mode": "snapped"
# Container calls now take ~1μs instead of ~1-5ms!
----

=== Mode 3: Distributed

Run on multiple Erlang nodes:

[source,bash]
----
# Node 1: Vörðr
cd ~/Documents/hyperpolymath-repos/cerro_torre_stack
iex --name vordr@10.0.1.10 --cookie secret -S mix phx.server --prefix vordr

# Node 2: Svalinn
cd ~/Documents/hyperpolymath-repos/cerro_torre_stack
iex --name svalinn@10.0.1.11 --cookie secret -S mix phx.server --prefix svalinn

# In svalinn IEx console:
Node.connect(:"vordr@10.0.1.10")
# VordrAdapter can now use :rpc.call for cross-node communication
----

== Development

=== Running Tests

[source,bash]
----
# All apps
mix test

# Specific app
mix test --prefix svalinn

# With coverage
mix test --cover
----

=== Building for Production

[source,bash]
----
# Build release (separate mode)
MIX_ENV=prod mix release svalinn

# Build release (snapped mode - include Vörðr)
MIX_ENV=prod mix release cerro_torre_stack

# Run
_build/prod/rel/svalinn/bin/svalinn start
----

== Performance Comparison

[cols="1,1,1"]
|===
| Operation | Separate Mode | Snapped Mode

| Create container
| ~3-5ms
| ~50μs (60× faster)

| List containers
| ~2-4ms
| ~20μs (100× faster)

| Health check
| ~1ms
| ~1μs (1000× faster)
|===

**Snapped mode benefits:**

* No HTTP overhead
* No JSON serialization
* No network stack
* Direct function calls
* Shared memory (zero copy)

== Configuration

=== Environment Variables

[source,bash]
----
# Svalinn
SVALINN_PORT=8000              # HTTP port (default: 8000)
VORDR_ENDPOINT=http://...      # Vörðr URL in separate mode
SECRET_KEY_BASE=...            # Phoenix secret (prod only)
PHX_HOST=example.com           # Public hostname (prod only)

# Vörðr (when running separately)
VORDR_PORT=8080                # HTTP port (default: 8080)
VORDR_MCP_ENABLED=true         # Enable MCP server
----

=== Runtime Configuration

Edit `config/runtime.exs`:

[source,elixir]
----
config :svalinn, SvalinnWeb.Endpoint,
  http: [port: String.to_integer(System.get_env("SVALINN_PORT") || "8000")]

config :svalinn,
  vordr_endpoint: System.get_env("VORDR_ENDPOINT") || "http://localhost:8080"
----

== API Examples

=== Health Check

[source,bash]
----
$ curl http://localhost:8000/health | jq
{
  "status": "healthy",
  "version": "0.1.0",
  "vordr_connected": true,
  "vordr_mode": "snapped",
  "vordr_mode_description": "Snapped (direct calls, ~1μs latency)",
  "timestamp": "2026-01-25T..."
}
----

=== Create Container

[source,bash]
----
$ curl -X POST http://localhost:8000/api/v1/containers \
  -H "Content-Type: application/json" \
  -d '{
    "imageName": "alpine:latest",
    "imageDigest": "sha256:...",
    "name": "test-container",
    "config": {
      "cmd": ["/bin/sh"],
      "env": {"FOO": "bar"}
    }
  }'

{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "test-container",
  "image": "alpine:latest",
  "image_digest": "sha256:...",
  "state": "created",
  "policy_verdict": "ALLOW",
  "created_at": "2026-01-25T..."
}
----

=== Verify Image

[source,bash]
----
$ curl -X POST http://localhost:8000/api/v1/verify \
  -H "Content-Type: application/json" \
  -d '{
    "imageName": "alpine:latest",
    "imageDigest": "sha256:..."
  }'

{
  "verified": true,
  "signatures": ["cosign-signature-1"],
  "sbom": {
    "packages": [...],
    "vulnerabilities": []
  }
}
----

== Troubleshooting

=== "vordr_mode": "separate" but I want snapped

**Symptom:** Health endpoint shows separate mode even though Vörðr is in umbrella.

**Solution:**

1. Verify Vörðr is in `apps/vordr/`
2. Clean build: `mix clean && mix deps.get && mix compile`
3. Check VordrAdapter compiled: `grep "SNAPPED MODE" _build/dev/lib/svalinn/ebin/Elixir.Svalinn.VordrAdapter.beam` (binary grep, may not work - check compilation output instead)

=== Connection refused errors

**Symptom:** `{"error":"Failed to list containers","details":"%Req.TransportError{reason: :econnrefused}"}`

**Solution (separate mode):**

1. Ensure Vörðr is running: `curl http://localhost:8080/health`
2. Check `VORDR_ENDPOINT` environment variable
3. Check firewall rules

**Solution (snapped mode):**

* This error shouldn't occur in snapped mode - verify mode with `/adapter` endpoint

=== Dialyzer warnings about unreachable :snapped clauses

**Symptom:** `warning: the following clause will never match: :snapped`

**This is expected!** In separate mode (Vörðr not in umbrella), `:snapped` clauses are unreachable. When you add Vörðr to umbrella, these warnings disappear.

== Next Steps

. **Migrate Vörðr:** Move existing Vörðr Elixir code into `apps/vordr/` for snap mode
. **Authentication:** Implement JWT middleware using Joken
. **JSON Schema Validation:** Wire ExJsonSchema into controllers
. **Integration Tests:** Test both deployment modes
. **Documentation:** Add OpenAPI spec for HTTP API
. **Monitoring:** Add Telemetry metrics for performance tracking

== License

PMPL-1.0-or-later (Polymorphic Permissive Multi-License)
