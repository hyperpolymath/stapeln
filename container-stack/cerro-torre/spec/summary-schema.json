{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cerro-torre.org/schemas/summary.schema.json",
  "title": "Cerro Torre Build Summary",
  "description": "Hash-stable, post-canonicalize build summary for signing and provenance chains. Generated by the build core after parsing and validating a .ctp manifest.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "generated_at_utc",
    "manifest",
    "subject",
    "inputs",
    "build_plan",
    "outputs",
    "policy",
    "security"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+$",
      "description": "Version of this summary schema (not the manifest)."
    },
    "generated_at_utc": {
      "type": "string",
      "format": "date-time",
      "description": "When this summary was generated."
    },
    "manifest": {
      "type": "object",
      "description": "Metadata about the source .ctp manifest.",
      "additionalProperties": false,
      "required": [
        "ctp_version",
        "kind",
        "name",
        "version",
        "canonical_bytes_sha256"
      ],
      "properties": {
        "ctp_version": {
          "type": "string",
          "description": "CTP format version from the manifest."
        },
        "kind": {
          "type": "string",
          "description": "What the manifest produces: container_image, package, rootfs, etc."
        },
        "name": {
          "type": "string",
          "minLength": 1
        },
        "version": {
          "type": "string",
          "minLength": 1
        },
        "canonical_bytes_sha256": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 of the canonicalized .ctp bytes (LF-only, sorted keys, no trailing whitespace)."
        },
        "source_path": {
          "type": "string",
          "description": "Optional: repository path to the .ctp file."
        }
      }
    },
    "subject": {
      "type": "object",
      "description": "What this manifest builds (for in-toto subject field).",
      "additionalProperties": false,
      "required": [
        "kind",
        "name",
        "version"
      ],
      "properties": {
        "kind": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "version": {
          "type": "string"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "inputs": {
      "type": "object",
      "description": "All inputs to the build with cryptographic hashes.",
      "additionalProperties": false,
      "required": [
        "upstream",
        "sources"
      ],
      "properties": {
        "upstream": {
          "type": "object",
          "description": "Upstream distribution information.",
          "additionalProperties": false,
          "required": [
            "family",
            "suite",
            "snapshot_timestamp_utc",
            "snapshot_service"
          ],
          "properties": {
            "family": {
              "type": "string",
              "description": "Distribution family: debian, fedora, alpine, etc."
            },
            "suite": {
              "type": "string",
              "description": "Distribution suite/release: bookworm, f39, edge, etc."
            },
            "snapshot_timestamp_utc": {
              "type": "string",
              "format": "date-time",
              "description": "Pinned snapshot timestamp for reproducibility."
            },
            "snapshot_service": {
              "type": "string",
              "description": "Snapshot service URL/identifier."
            }
          }
        },
        "sources": {
          "type": "array",
          "description": "All source packages with resolved artifact hashes.",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "id",
              "type",
              "name",
              "version",
              "resolved_artifacts"
            ],
            "properties": {
              "id": {
                "type": "string",
                "minLength": 1,
                "description": "Unique identifier for this source within the manifest."
              },
              "type": {
                "type": "string",
                "description": "Source type: debian_dsc, fedora_srpm, alpine_apkbuild, tarball, git."
              },
              "name": {
                "type": "string",
                "description": "Package name."
              },
              "version": {
                "type": "string",
                "description": "Package version."
              },
              "resolved_artifacts": {
                "type": "array",
                "description": "Individual files with verified hashes.",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": [
                    "filename",
                    "uri",
                    "sha256"
                  ],
                  "properties": {
                    "filename": {
                      "type": "string"
                    },
                    "uri": {
                      "type": "string",
                      "format": "uri"
                    },
                    "sha256": {
                      "type": "string",
                      "pattern": "^[a-f0-9]{64}$"
                    },
                    "size_bytes": {
                      "type": "integer",
                      "minimum": 0
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "build_plan": {
      "type": "object",
      "description": "Normalized build plan after validation.",
      "additionalProperties": false,
      "required": [
        "environment",
        "normalized_steps_sha256",
        "steps"
      ],
      "properties": {
        "environment": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "os",
            "arch",
            "reproducible"
          ],
          "properties": {
            "os": {
              "type": "string"
            },
            "arch": {
              "type": "string"
            },
            "reproducible": {
              "type": "boolean",
              "description": "Whether reproducible build is required/expected."
            }
          }
        },
        "normalized_steps_sha256": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 of canonical JSON of steps (stable ordering, defaults applied)."
        },
        "steps": {
          "type": "array",
          "description": "Build steps in execution order.",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "step"
            ],
            "properties": {
              "step": {
                "type": "string",
                "description": "Step type: import, build_debian_source, assemble_rootfs, emit_oci_image, etc."
              },
              "using": {
                "type": "string"
              },
              "source": {
                "type": "string"
              },
              "sources": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "profile": {
                "type": "string"
              },
              "include_packages": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": [
                    "name",
                    "from_source"
                  ],
                  "properties": {
                    "name": {
                      "type": "string"
                    },
                    "from_source": {
                      "type": "string"
                    }
                  }
                }
              },
              "image": {
                "type": "object",
                "additionalProperties": true,
                "description": "OCI image configuration."
              }
            }
          }
        }
      }
    },
    "outputs": {
      "type": "object",
      "description": "Build outputs with hashes (filled after build completes).",
      "additionalProperties": false,
      "required": [
        "artifacts"
      ],
      "properties": {
        "artifacts": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "type",
              "sha256"
            ],
            "properties": {
              "type": {
                "type": "string",
                "description": "Artifact type: oci_image, rootfs_tar, sbom_spdx_json, in_toto_provenance."
              },
              "sha256": {
                "type": "string",
                "pattern": "^[a-f0-9]{64}$"
              },
              "ref": {
                "type": "string",
                "description": "Optional locator: OCI digest ref, file path, etc."
              },
              "size_bytes": {
                "type": "integer",
                "minimum": 0
              }
            }
          }
        }
      }
    },
    "policy": {
      "type": "object",
      "description": "Policy requirements from the manifest.",
      "additionalProperties": false,
      "required": [
        "provenance",
        "attestations"
      ],
      "properties": {
        "provenance": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "require_source_hashes",
            "require_reproducible_build"
          ],
          "properties": {
            "require_source_hashes": {
              "type": "boolean"
            },
            "require_reproducible_build": {
              "type": "boolean"
            }
          }
        },
        "attestations": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "emit"
          ],
          "properties": {
            "emit": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Attestation types to emit: in_toto, sbom_spdx_json, sbom_cyclonedx, etc."
            }
          }
        }
      }
    },
    "security": {
      "type": "object",
      "description": "Crypto suite commitment. The suite_id is covered by signatures to prevent downgrade.",
      "additionalProperties": false,
      "required": [
        "suite_id",
        "algorithms",
        "binding_digest"
      ],
      "properties": {
        "suite_id": {
          "type": "string",
          "minLength": 1,
          "description": "Suite identifier from spec/crypto-suites.json (e.g., CT-SIG-01, CT-SIG-02)."
        },
        "algorithms": {
          "type": "object",
          "description": "Resolved algorithm set from the suite registry.",
          "additionalProperties": false,
          "required": [
            "hash",
            "signatures"
          ],
          "properties": {
            "hash": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "id",
                "output_bits"
              ],
              "properties": {
                "id": {
                  "type": "string"
                },
                "output_bits": {
                  "type": "integer"
                }
              }
            },
            "signatures": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "id",
                  "required"
                ],
                "properties": {
                  "id": {
                    "type": "string"
                  },
                  "required": {
                    "type": "boolean"
                  }
                }
              }
            }
          }
        },
        "binding_digest": {
          "type": "object",
          "description": "The digest that binds the manifest to signatures.",
          "additionalProperties": false,
          "required": [
            "id",
            "value"
          ],
          "properties": {
            "id": {
              "type": "string",
              "description": "Digest algorithm (e.g., sha256)."
            },
            "value": {
              "type": "string",
              "pattern": "^[a-f0-9]{64}$",
              "description": "Hex-encoded digest value."
            }
          }
        }
      }
    },
    "signatures": {
      "type": "array",
      "description": "Signatures over this summary. Suite-committed: each signature includes suite_id.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "suite_id",
          "key_id",
          "algorithm",
          "signature"
        ],
        "properties": {
          "suite_id": {
            "type": "string",
            "description": "Suite ID this signature belongs to. Must match security.suite_id."
          },
          "key_id": {
            "type": "string",
            "description": "Key identifier from trust store."
          },
          "algorithm": {
            "type": "string",
            "description": "Signature algorithm: ed25519, ml-dsa-87, ed448, etc."
          },
          "signature": {
            "type": "string",
            "description": "Base64-encoded signature."
          }
        }
      }
    }
  }
}
