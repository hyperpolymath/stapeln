# Build Summary Format

**Version**: 1.0
**Status**: Draft Specification
**SPDX-License-Identifier**: PMPL-1.0-or-later

## Overview

The build summary (`summary.json`) is a hash-stable, post-parse artifact generated by the Cerro Torre build core after validating a `.ctp` manifest. It serves as:

1. **Signing target** — The canonical representation that gets signed
2. **Provenance anchor** — Links manifest to build outputs with cryptographic hashes
3. **Verification target** — What the ATS2 shadow verifier checks against

## Relationship to .ctp Manifests

```
.ctp manifest (TOML, human-editable)
    ↓ parse + validate
summary.json (JSON, machine-generated)
    ↓ sign
signatures.json (algorithm-agile signatures)
```

The summary captures:
- The canonical SHA-256 of the manifest bytes
- Resolved artifact hashes (after fetching)
- Normalized build plan
- Output hashes (after build completes)

## Schema

The JSON Schema is defined in `spec/summary-schema.json` (JSON Schema draft 2020-12).

## Key Fields

### `manifest.canonical_bytes_sha256`

SHA-256 of the canonicalized `.ctp` bytes:
- LF-only line endings (no CR)
- No TAB characters
- No trailing whitespace
- Keys sorted within sections
- Ends with exactly one LF

This hash is stable across platforms given the same manifest content.

### `inputs.sources[].resolved_artifacts`

After fetching sources, each artifact has its hash recorded. This differs from the manifest which may use placeholders during development.

### `build_plan.normalized_steps_sha256`

SHA-256 of the canonical JSON representation of build steps after:
- Validation (all required fields present)
- Normalization (defaults applied)
- Ordering (deterministic key order)

### `outputs.artifacts[].sha256`

Hashes of produced artifacts. Filled after build completes. For a successful reproducible build, these should match across independent builds.

### `signatures`

Algorithm-agile signatures using the format:

```json
{
  "algorithm": "ed25519",
  "keyid": "cerro-dev-2025",
  "sig": "base64..."
}
```

Supported algorithms:
- `ed25519` (MVP)
- `ml-dsa-65` (v0.2+, post-quantum)

## Generation

The build core generates `summary.json` in two phases:

### Phase 1: Pre-build (after manifest parse)

```json
{
  "schema_version": "1.0",
  "generated_at_utc": "...",
  "manifest": { "canonical_bytes_sha256": "..." },
  "subject": { ... },
  "inputs": { ... },
  "build_plan": { ... },
  "outputs": { "artifacts": [] },
  "policy": { ... },
  "signatures": []
}
```

### Phase 2: Post-build (after successful build)

The `outputs.artifacts` array is populated with actual hashes:

```json
{
  "outputs": {
    "artifacts": [
      {
        "type": "oci_image",
        "sha256": "actual_hash_here",
        "ref": "oci://..."
      }
    ]
  }
}
```

## Verification

### ATS2 Shadow Verifier

The non-authoritative ATS2 shadow verifier (`tools/ats-shadow/`) can check:

```bash
# Check digest coupling
./ct-shadow --summary summary.json --check-digest canonical.ctp

# Check idempotence
./ct-shadow --canon-cmd "cerro canonicalize" --check-idempotence canonical.ctp
```

### SPARK Core Verifier

The authoritative SPARK verifier validates:
- All required fields present
- All hashes are valid hex strings
- Referenced sources exist in manifest
- Build plan steps are valid vocabulary
- Signatures verify against trust store

## Example

See `manifests/examples/ct-minbase.summary.json` for a complete example.

## Invariants

The following invariants must hold:

| Invariant | Description |
|-----------|-------------|
| Hash stability | Same manifest bytes → same `canonical_bytes_sha256` |
| Input completeness | All fetched artifacts appear in `inputs.sources` |
| Output traceability | All `outputs.artifacts` have corresponding build step |
| Plan determinism | Same manifest → same `normalized_steps_sha256` |
| Signature validity | All signatures verify with trust store keys |
