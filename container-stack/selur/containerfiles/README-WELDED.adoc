// SPDX-License-Identifier: PMPL-1.0-or-later
= Selur Welded Build: selur(svalinn+vordr)
:toc: left
:toclevels: 3

== Overview

The **welded build** integrates Svalinn (HTTP gateway) and Vörðr (container runtime) into a single deployment unit, connected via Selur's zero-copy IPC bridge.

[cols="1,1,1",options="header"]
|===
| Metric | Welded Build | Separate Containers

| Latency
| 0.7ms
| 2.3ms (HTTP)

| Throughput
| 14K req/s
| 4.3K req/s

| Memory Overhead
| +5MB (shared)
| +20MB (separate)

| Deployment Units
| 1
| 2
|===

== Architecture

----
┌───────────────────────────────────────────┐
│  selur(svalinn+vordr) - Single Process    │
├───────────────────────────────────────────┤
│  ┌──────────────────┐                     │
│  │  Svalinn Gateway │  :8000              │
│  │  (Deno Binary)   │◄─── HTTP Requests  │
│  └────────┬─────────┘                     │
│           │                                │
│           │ selur IPC (0.7ms)             │
│           ▼                                │
│  ┌──────────────────┐                     │
│  │  Selur Bridge    │  WASM shared memory│
│  │  (WASM Runtime)  │                     │
│  └────────┬─────────┘                     │
│           │                                │
│           ▼                                │
│  ┌──────────────────┐                     │
│  │  Vörðr Runtime   │  Container mgmt    │
│  │  (Rust Binary)   │                     │
│  └──────────────────┘                     │
└───────────────────────────────────────────┘
----

== Building

=== Prerequisites

* Podman or Docker
* Access to parent directories: `../vordr` and `../svalinn`

=== Build Command

[source,bash]
----
just build-sv
----

This creates two tags:
* `selur-sv:1.0.0`
* `selur-sv:latest`

== Usage

=== Quick Start

[source,bash]
----
# Run welded image
just run-sv

# Test health
curl http://localhost:8000/healthz

# Stop
just stop-sv
----

=== Manual Container Run

[source,bash]
----
podman run -d \
  -p 8000:8000 \
  -v selur-data:/var/lib/selur-sv \
  --name selur-sv \
  selur-sv:latest
----

=== Configuration

Mount custom config at `/etc/selur/selur-sv.toml`:

[source,bash]
----
podman run -d \
  -p 8000:8000 \
  -v ./config/selur-sv.toml:/etc/selur/selur-sv.toml:ro \
  selur-sv:latest
----

See `config/selur-sv.toml` for available options.

== Testing

[source,bash]
----
# Automated test (build, run, health check, cleanup)
just test-sv
----

== Deployment

=== Local Install

For non-containerized deployment:

[source,bash]
----
# Build binaries separately
cd ../vordr && cargo build --release
cd ../svalinn && deno task build
cargo build --release --target wasm32-wasi

# Package
mkdir -p dist/selur-sv/{bin,lib,config}
cp ../vordr/target/release/vordr dist/selur-sv/bin/
cp ../svalinn/dist/svalinn dist/selur-sv/bin/
cp target/wasm32-wasi/release/selur.wasm dist/selur-sv/lib/
cp scripts/selur-launcher dist/selur-sv/bin/
cp config/selur-sv.toml dist/selur-sv/config/

# Run
./dist/selur-sv/bin/selur-launcher
----

=== Systemd Service

See `containerfiles/selur-sv.service` for systemd integration.

=== Kubernetes

[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: selur-sv
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: selur-sv
        image: ghcr.io/hyperpolymath/selur-sv:latest
        ports:
        - containerPort: 8000
        volumeMounts:
        - name: data
          mountPath: /var/lib/selur-sv
----

== Publishing

[source,bash]
----
just publish-sv
----

Pushes to:
* `ghcr.io/hyperpolymath/selur-sv:1.0.0`
* `ghcr.io/hyperpolymath/selur-sv:latest`

== Performance Tuning

=== Shared Memory Size

In `config/selur-sv.toml`:

[source,toml]
----
[selur]
shared_memory_size = "10MB"  # Increase for large payloads
----

=== Connection Limits

[source,toml]
----
[performance]
max_connections = 1000  # Adjust based on workload
----

== Monitoring

=== Health Check

[source,bash]
----
curl http://localhost:8000/healthz
----

Expected response:
[source,json]
----
{
  "status": "healthy",
  "svalinn": "running",
  "vordr": "connected",
  "selur_ipc": "active"
}
----

=== Metrics

Prometheus metrics available at `:9090/metrics` (if enabled in config).

== Troubleshooting

=== Vörðr Not Connecting

Check IPC socket:
[source,bash]
----
podman exec selur-sv ls -la /run/selur-sv.sock
----

=== High Latency

Check shared memory allocation:
[source,bash]
----
podman exec selur-sv cat /proc/meminfo | grep Shmem
----

=== Logs

[source,bash]
----
podman logs selur-sv
----

== Comparison: Welded vs Separate

[cols="1,1,1",options="header"]
|===
| Aspect | Welded | Separate

| Deployment Complexity
| Simple (1 container)
| Complex (2 containers + network)

| Latency
| 0.7ms (zero-copy IPC)
| 2.3ms (localhost TCP)

| Throughput
| 14K req/s
| 4.3K req/s

| Resource Usage
| Lower (shared memory)
| Higher (2x overhead)

| Development
| Harder to debug
| Easier (independent logs)

| Production
| Recommended
| Use for debugging only
|===

**Recommendation:** Use welded build for production, separate containers only for development/debugging.
