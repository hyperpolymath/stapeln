# SPDX-License-Identifier: PMPL-1.0-or-later
name: CI

permissions: read-all

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  zig-wasm:
    name: Build Zig WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4
      
      - name: Install Zig
        uses: goto-bus-stop/setup-zig@7ab2955eb728f5440978d5824358023be3a2802d  # v2
        with:
          version: master  # Use latest dev build (0.16.0-dev compatible)
      
      - name: Build selur.wasm
        run: |
          cd zig
          zig build
      
      - name: Verify WASM output
        run: |
          file zig/zig-out/bin/selur.wasm
          ls -lh zig/zig-out/bin/selur.wasm
      
      - name: Upload WASM artifact
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8  # v4
        with:
          name: selur-wasm
          path: zig/zig-out/bin/selur.wasm

  idris2-proofs:
    name: Verify Idris2 Proofs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4
      
      - name: Install Idris2
        run: |
          sudo apt-get update
          sudo apt-get install -y idris2
      
      - name: Verify proofs
        run: |
          cd idris
          idris2 --check Proofs.idr
          idris2 --check Theorems.idr
      
      - name: Run just verify
        run: |
          # Install just
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          just verify

  rust-check:
    name: Rust Check
    runs-on: ubuntu-latest
    needs: zig-wasm
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b  # stable
        with:
          toolchain: stable
          components: rustfmt, clippy
      
      - name: Download WASM artifact
        uses: actions/download-artifact@6b208ae046db98c579e8a3aa621ab581ff575935  # v4
        with:
          name: selur-wasm
          path: zig/zig-out/bin/
      
      - name: Cache Cargo registry
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9  # v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.toml') }}
      
      - name: Cache Cargo index
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9  # v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.toml') }}
      
      - name: Cache target directory
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9  # v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.toml') }}
      
      - name: Check formatting
        run: cargo fmt -- --check
      
      - name: Run clippy
        run: cargo clippy -- -D warnings
      
      - name: Run tests
        run: cargo test
      
      - name: Build example
        run: cargo build --example basic

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [zig-wasm, idris2-proofs, rust-check]
    steps:
      - name: Summary
        run: |
          echo "✓ Zig WASM compilation successful"
          echo "✓ Idris2 proofs verified"
          echo "✓ Rust checks passed"
