#!/bin/bash
# SPDX-License-Identifier: PMPL-1.0-or-later
# Launcher for complete stack: svalinn + vordr + cerro-torre

set -euo pipefail

echo "ðŸš€ Starting selur(svalinn+vordr+ct) complete stack..."

# Start vordr with selur IPC
/usr/local/bin/vordr \
  --selur-ipc unix:///run/selur-sv.sock \
  --listen-mode ipc \
  --state-db /var/lib/selur-sv/vordr.db &
VORDR_PID=$!

# Wait for vordr to be ready
sleep 2

echo "âœ… VÃ¶rÃ°r started (PID: $VORDR_PID)"

# Start svalinn gateway
VORDR_ENDPOINT="selur://unix:///run/selur-sv.sock" \
SELUR_WASM="/usr/local/lib/selur.wasm" \
/usr/local/bin/svalinn &
SVALINN_PID=$!

echo "âœ… Svalinn started (PID: $SVALINN_PID)"
echo "ðŸ“¡ Gateway: http://0.0.0.0:${SVALINN_PORT:-8000}"
echo "ðŸ”— IPC bridge: unix:///run/selur-sv.sock (0.7ms latency)"
echo "ðŸ”ï¸  Cerro Torre: Available as 'ct' command"
echo ""
echo "Example commands:"
echo "  ct pack nginx:latest -o nginx.ctp"
echo "  ct sign nginx.ctp -k release-key"
echo "  ct verify nginx.ctp --policy strict"
echo "  curl -X POST http://localhost:8000/v1/run -d '{\"bundle\":\"nginx.ctp\"}'"

# Wait for svalinn (main process)
wait $SVALINN_PID

# Cleanup
echo "ðŸ›‘ Shutting down..."
kill $VORDR_PID 2>/dev/null || true
