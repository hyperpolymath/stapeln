= selur-compose
:toc:
:toclevels: 3

**Multi-container orchestration for verified containers (.ctp bundles)**

== Overview

selur-compose is a docker-compose equivalent for deploying multi-service applications using verified containers (`.ctp` bundles). It leverages https://github.com/hyperpolymath/selur[selur]'s zero-copy IPC, https://github.com/hyperpolymath/svalinn[Svalinn] gateway, and https://github.com/hyperpolymath/vordr[Vörðr] orchestrator to provide:

* **Zero-copy IPC** - 7-20x faster than JSON/HTTP
* **Formal verification** - Cryptographically verified container images
* **Policy enforcement** - Runtime policy validation
* **Reversibility** - Rollback failed deployments
* **Multi-service orchestration** - Docker Compose-like experience

== Features

=== Core Capabilities

* **Declarative configuration** - TOML-based compose files
* **Service dependencies** - Automatic ordering and health checks
* **Network isolation** - Per-service network policies
* **Volume management** - Persistent and ephemeral storage
* **Environment variables** - Secrets and configuration injection
* **Scaling** - Horizontal scaling of services
* **Rolling updates** - Zero-downtime deployments

=== Security & Verification

* **Signature verification** - All `.ctp` bundles cryptographically verified
* **SBOM validation** - Software Bill of Materials checked
* **Transparency logs** - Rekor/CT-TLOG integration
* **Policy-based deployment** - Reject non-compliant images
* **Audit logging** - Complete deployment history

=== Performance

* **Zero-copy communication** - WASM linear memory shared between services
* **Sub-millisecond latency** - <100 μs service-to-service calls
* **10,000+ req/s throughput** - Per service pair
* **Fixed memory footprint** - Predictable resource usage

== Quick Start

=== Installation

[source,bash]
----
# Install from GitHub releases
curl -fsSL https://github.com/hyperpolymath/selur-compose/releases/latest/download/selur-compose-linux-x86_64.tar.gz | tar xz
sudo mv selur-compose /usr/local/bin/

# Or build from source
git clone https://github.com/hyperpolymath/selur-compose.git
cd selur-compose
cargo build --release
sudo cp target/release/selur-compose /usr/local/bin/
----

=== Runtime Endpoints

selur-compose talks to Svalinn for container runs and to Vörðr MCP for network/volume lifecycle.

[source,bash]
----
export SVALINN_URL=http://localhost:8080
export VORDR_MCP_URL=http://localhost:8081
----

=== Create Compose File

Create `compose.toml`:

[source,toml]
----
version = "1.0"

[services.web]
image = "ghcr.io/hyperpolymath/nginx:latest.ctp"
ports = ["8080:80"]
depends_on = ["api"]
environment = { API_URL = "http://api:3000" }

[services.api]
image = "ghcr.io/myorg/myapi:v1.2.3.ctp"
ports = ["3000:3000"]
depends_on = ["db"]
environment = { DATABASE_URL = "postgres://db:5432/mydb" }
volumes = ["./data:/app/data"]

[services.db]
image = "ghcr.io/hyperpolymath/postgres:16.ctp"
ports = ["5432:5432"]
environment = { POSTGRES_PASSWORD = "secret" }
volumes = ["pgdata:/var/lib/postgresql/data"]

[volumes]
pgdata = { driver = "local" }

[networks.default]
driver = "selur"
----

NOTE: Relative bind mounts are not yet supported by Vörðr MCP. Use absolute host paths or named volumes for now.

=== Deploy

[source,bash]
----
# Verify all images
selur-compose verify

# Start all services
selur-compose up

# Check status
selur-compose ps

# View logs
selur-compose logs -f web

# Scale API service
selur-compose scale api=3

# Stop all services
selur-compose down
----

== Architecture

[source]
----
┌─────────────────────────────────────────────────────┐
│ selur-compose CLI (Rust)                            │
│  - Parse compose.toml                               │
│  - Verify .ctp bundles                              │
│  - Orchestrate deployment                           │
│  - Health checks & dependencies                     │
└─────────────────┬───────────────────────────────────┘
                  │
                  │ TOML config
                  ↓
┌─────────────────────────────────────────────────────┐
│ Deployment Plan                                     │
│  - Service order (topological sort)                 │
│  - Network creation                                 │
│  - Volume provisioning                              │
│  - Environment injection                            │
└─────────────────┬───────────────────────────────────┘
                  │
                  │ Deploy via Svalinn
                  ↓
┌─────────────────────────────────────────────────────┐
│ Svalinn Gateway (ReScript + Deno)                   │
│  - Policy enforcement                               │
│  - Load balancing                                   │
│  - Request routing                                  │
└─────────────────┬───────────────────────────────────┘
                  │
                  │ selur zero-copy IPC
                  ↓
┌─────────────────────────────────────────────────────┐
│ selur.wasm (Zero-Copy Bridge)                       │
│  - WASM linear memory                               │
│  - 0 buffer copies                                  │
│  - <100 μs latency                                  │
└─────────────────┬───────────────────────────────────┘
                  │
                  │ Container lifecycle
                  ↓
┌─────────────────────────────────────────────────────┐
│ Vörðr Orchestrator (Elixir + Rust)                 │
│  - Container management                             │
│  - Supervision trees                                │
│  - Reversibility journal                            │
└─────────────────┬───────────────────────────────────┘
                  │
                  │ Run verified containers
                  ↓
┌─────────────────────────────────────────────────────┐
│ .ctp Bundle Runtime                                 │
│  - OCI-compatible                                   │
│  - Signature verified                               │
│  - SBOM validated                                   │
└─────────────────────────────────────────────────────┘
----

== Compose File Specification

=== Top-Level Fields

[source,toml]
----
version = "1.0"  # Compose file format version

[services]
# Service definitions

[volumes]
# Volume definitions

[networks]
# Network definitions

[secrets]
# Secret definitions
----

=== Service Definition

[source,toml]
----
[services.myservice]
image = "registry/repo:tag.ctp"           # Required: .ctp bundle reference
command = ["/app/server", "--port=8080"]  # Override container command
environment = { KEY = "value" }           # Environment variables
ports = ["8080:80", "8443:443"]          # Port mappings (host:container)
depends_on = ["db", "cache"]             # Service dependencies
volumes = ["./data:/app/data"]           # Volume mounts
networks = ["frontend", "backend"]        # Networks to join
restart = "always"                        # Restart policy
healthcheck = { test = "curl -f http://localhost/health", interval = "30s" }
deploy = { replicas = 3, strategy = "rolling" }
----

=== Volume Definition

[source,toml]
----
[volumes.myvolume]
driver = "local"                          # Volume driver
driver_opts = { type = "tmpfs" }         # Driver options
labels = { app = "myapp" }               # Volume labels
----

=== Network Definition

[source,toml]
----
[networks.mynetwork]
driver = "selur"                          # Network driver (selur = zero-copy)
driver_opts = { mtu = "1500" }           # Driver options
ipam = { subnet = "10.0.1.0/24" }        # IP address management
----

=== Secret Definition

[source,toml]
----
[secrets.db_password]
file = "./secrets/db_password.txt"       # Read from file
# OR
external = true                           # Use external secret (from vault)
----

== Commands

=== Core Commands

[source,bash]
----
selur-compose up [-d]              # Start all services (detached)
selur-compose down                 # Stop and remove all services
selur-compose start [service...]   # Start stopped services
selur-compose stop [service...]    # Stop running services
selur-compose restart [service...] # Restart services
selur-compose ps                   # List services
selur-compose logs [-f] [service]  # View logs (follow)
----

=== Management Commands

[source,bash]
----
selur-compose build [service...]   # Build .ctp bundles from source
selur-compose pull [service...]    # Pull .ctp bundles from registry
selur-compose push [service...]    # Push .ctp bundles to registry
selur-compose exec service cmd     # Execute command in service
selur-compose run service cmd      # Run one-off command
selur-compose scale service=N      # Scale service to N replicas
----

=== Verification Commands

[source,bash]
----
selur-compose verify               # Verify all .ctp bundle signatures
selur-compose policy               # Check policy compliance
selur-compose sbom [service]       # Show SBOM for service
selur-compose provenance [service] # Show build provenance
----

=== Debugging Commands

[source,bash]
----
selur-compose config               # Validate and view merged config
selur-compose top [service]        # Display running processes
selur-compose events               # Stream real-time events
selur-compose inspect service      # View service details (JSON)
----

== Environment Variables

[source,bash]
----
SELUR_COMPOSE_FILE=./compose.toml  # Path to compose file
SELUR_PROJECT_NAME=myproject       # Project name (default: dir name)
SELUR_COMPOSE_PARALLEL=4           # Parallel operations
SELUR_REGISTRY_AUTH=~/.selur/auth  # Registry credentials
SELUR_POLICY_FILE=~/.selur/policy  # Default policy file
----

== Use Cases

=== Web Application

[source,toml]
----
version = "1.0"

[services.frontend]
image = "ghcr.io/myorg/frontend:latest.ctp"
ports = ["3000:3000"]
environment = { BACKEND_URL = "http://backend:8080" }

[services.backend]
image = "ghcr.io/myorg/backend:latest.ctp"
ports = ["8080:8080"]
depends_on = ["postgres", "redis"]
environment = { DATABASE_URL = "postgres://postgres:5432/app" }

[services.postgres]
image = "ghcr.io/hyperpolymath/postgres:16.ctp"
volumes = ["pgdata:/var/lib/postgresql/data"]

[services.redis]
image = "ghcr.io/hyperpolymath/redis:7.ctp"
volumes = ["redisdata:/data"]

[volumes]
pgdata = {}
redisdata = {}
----

=== Microservices

[source,toml]
----
version = "1.0"

[services.gateway]
image = "ghcr.io/myorg/api-gateway:v1.ctp"
ports = ["8080:8080"]
depends_on = ["auth", "users", "orders"]

[services.auth]
image = "ghcr.io/myorg/auth-service:v1.ctp"
environment = { JWT_SECRET = { secret = "jwt_key" } }

[services.users]
image = "ghcr.io/myorg/user-service:v1.ctp"
depends_on = ["postgres"]
deploy = { replicas = 3 }

[services.orders]
image = "ghcr.io/myorg/order-service:v1.ctp"
depends_on = ["postgres", "kafka"]
deploy = { replicas = 5 }

[services.postgres]
image = "ghcr.io/hyperpolymath/postgres:16.ctp"
volumes = ["pgdata:/var/lib/postgresql/data"]

[services.kafka]
image = "ghcr.io/hyperpolymath/kafka:3.ctp"
volumes = ["kafkadata:/var/lib/kafka"]

[volumes]
pgdata = {}
kafkadata = {}

[networks.backend]
driver = "selur"
----

== Differences from Docker Compose

|===
| Feature | docker-compose | selur-compose

| **Image format**
| OCI images (Docker Hub)
| `.ctp` bundles (verified containers)

| **IPC mechanism**
| JSON/HTTP (4 buffer copies)
| WASM linear memory (0 copies)

| **Latency**
| 700-2000 μs
| <100 μs (7-20x faster)

| **Verification**
| Optional (Notary v2)
| Required (signatures + SBOM + logs)

| **Policy enforcement**
| Manual (OPA/Gatekeeper)
| Built-in (Svalinn gateway)

| **Reversibility**
| Manual rollback
| Automatic (Vörðr journal)

| **Configuration**
| YAML
| TOML (stricter, less ambiguous)

| **Network driver**
| bridge, overlay
| selur (zero-copy), bridge
|===

== Performance Comparison

=== Traditional Docker Compose Stack

[source]
----
Request flow:
Frontend → JSON encode → HTTP → JSON decode → Backend
         └─ copy 1 ──┘  └ copy 2 ┘  └─ copy 3 ──┘
Backend → JSON encode → HTTP → JSON decode → Database
        └─ copy 4 ──┘  └ copy 5 ┘  └─ copy 6 ──┘

Total: 6 buffer copies, 1400-4000 μs latency
----

=== selur-compose Stack

[source]
----
Request flow:
Frontend → WASM memory (shared) → Backend
         └────── 0 copies ──────┘
Backend → WASM memory (shared) → Database
        └────── 0 copies ──────┘

Total: 0 buffer copies, <200 μs latency
----

**Result:** 7-20x faster, predictable performance.

== Roadmap

=== v0.1 (MVP) - Q2 2026

- [ ] TOML parser for compose files
- [ ] Basic service lifecycle (up/down/ps/logs)
- [ ] .ctp bundle verification
- [ ] Dependency ordering
- [ ] Port mapping
- [ ] Environment variables
- [ ] Volume mounting

=== v0.2 - Q3 2026

- [ ] Health checks
- [ ] Service scaling
- [ ] Rolling updates
- [ ] Network isolation
- [ ] Secret management
- [ ] Build command (pack .ctp bundles)
- [ ] Policy validation

=== v1.0 - Q4 2026

- [ ] Complete docker-compose compatibility
- [ ] Horizontal scaling with load balancing
- [ ] Advanced networking (overlay, mesh)
- [ ] Metrics and observability
- [ ] CI/CD integration (GitHub Actions, GitLab)
- [ ] Kubernetes integration
- [ ] Production-ready

== Contributing

We welcome contributions!

**Priority areas:**

- Docker Compose migration guide
- Additional network drivers
- Metrics exporters (Prometheus, Grafana)
- CI/CD plugins
- Documentation improvements

See link:CONTRIBUTING.adoc[Contributing Guide] for details.

== Community

- **Repository:** https://github.com/hyperpolymath/selur-compose
- **Issue Tracker:** https://github.com/hyperpolymath/selur-compose/issues
- **Discussions:** https://github.com/hyperpolymath/selur-compose/discussions
- **Email:** jonathan.jewell@open.ac.uk

**Part of the hyperpolymath ecosystem:**

- https://github.com/hyperpolymath/selur[selur] - Zero-copy WASM IPC bridge
- https://github.com/hyperpolymath/svalinn[Svalinn] - Edge gateway
- https://github.com/hyperpolymath/vordr[Vörðr] - Container orchestrator
- https://github.com/hyperpolymath/cerro-torre[Cerro Torre] - Verified containers

== License

PMPL-1.0-or-later (Polymath Public Mark License)

See link:LICENSE[LICENSE] for full terms.

== Maintainer

**Jonathan D.A. Jewell** <jonathan.jewell@open.ac.uk>

**Co-Authored-By:** Claude Sonnet 4.5 <noreply@anthropic.com>

---

**selur-compose** - Multi-container orchestration with zero-copy IPC and formal verification.
