= stapeln
:toc: left
:toclevels: 3
:icons: font
:source-highlighter: highlight.js

**Visual Container Stack Designer for Verified Containers**

image:https://img.shields.io/badge/License-PMPL--1.0--or--later-blue.svg[License: PMPL-1.0-or-later]
image:https://img.shields.io/badge/WCAG-2.3%20AAA-green.svg[WCAG 2.3 AAA]
image:https://img.shields.io/badge/Security-OWASP%20Compliant-brightgreen.svg[OWASP Compliant]
image:https://img.shields.io/badge/ReScript-TEA-e34c4c.svg[ReScript-TEA]
image:https://img.shields.io/badge/runtime-Deno-000000.svg[Deno]
image:https://img.shields.io/badge/backend-Elixir%20%2B%20Phoenix-4e2a8e.svg[Elixir]

_"Containers for People Who Hate Containers"_

== Product Goal

**A 12-year-old who is reasonably IT-capable can help their parents build a secure container stack.**
That means no prior container knowledge is required, and security guidance is clear, visual, and actionable.

== Current Status (as of 2026-02-13)

**Honest completion: ~35%**

[cols="2,1,3"]
|===
| Component | Status | Notes

| UI (8 views) | Working | All render, navigate, TEA pattern solid
| Backend (Phoenix REST + GraphQL) | Working | CRUD + basic validation live
| Zig FFI shared library | Working | Real CRUD + validation (not stubs)
| Zig CLI bridge | Working | JSON store persistence, full validation
| Export (JSON + compose files) | Working | Real container images, not `image: TODO`
| Import (JSON designs) | Working | Validation + round-trip support
| Simulation mode | Partial | WASM/JS packet kernel, sample data only
| Security inspector | Partial | UI renders with sample data, no backend calls
| Gap analysis | Partial | UI renders with sample data, no backend calls
| Settings | Partial | Form renders, localStorage save added
| Frontend-backend wiring | Partial | SaveStack/LoadStack wired, data model mismatch remains
| Idris2 proofs | Stubs | Declarations only, zero actual proofs
| miniKanren engine | Not started | Documentation only
| VeriSimDB integration | Not started | Documentation only
| Authentication | Not started | No PAM, JWT, or auth flow
| Database | Not started | In-memory GenServer only, no Ecto/PostgreSQL
| Post-quantum crypto | Not started | 0%
|===

See `STATUS.md` for the canonical source of truth.

This repo focuses on the stapeln app UI.
The DOM-mounter workstream has been extracted to a separate repo:
`/var/mnt/eclipse/repos/stapeln-dom-mounter`.

== What is stapeln?

stapeln (Swedish for "the stack") is a **visual drag-and-drop designer** for creating secure container stacks. It combines:

* ğŸ¨ **Game-like UI** - Choose components like customizing a spaceship
* ğŸ›¡ï¸ **Built-in Security** - Real-time attack surface analysis
* ğŸ” **Smart Validation** - miniKanren reasoning engine catches vulnerabilities
* â™¿ **Accessibility First** - WCAG 2.3 AAA compliance
* ğŸ”¥ **OWASP Integration** - ModSecurity firewall with ephemeral pinholes
* ğŸ“Š **Multi-Modal Database** - VeriSimDB (6 modalities)
* ğŸ“ **Attested Documentation** - A2ML with cryptographic signatures
* âœ… **Self-Validating Configs** - K9-SVC Nickel contracts

[quote, UX Manifesto]
____
"If you have to read the manual, we failed."
____

== Key Features

=== Four Visual Views

1. **Paragon View** (Vertical Stack)
   * Supply chain hierarchy from Cerro Torre â†’ containers â†’ provenance
   * Gap analysis sidebar shows security issues
   * Real-time validation
   * GParted-style vertical block layout

2. **Cisco View** (Network Topology)
   * Drag-and-drop components onto canvas
   * Draw connection lines between services
   * Simulation mode with animated packet flow
   * Configure ports visually (no CLI commands!)
   * Multiple shapes: box, oval, gateway, nested

3. **Lago Grey Designer** (Base Image Designer)
   * Visual minimal Linux distribution designer (Alpine/Chainguard alternative)
   * Interactive ice formation catalog (Floes < 1MB, Icebergs 1-75MB, Glaciers 75MB+)
   * Real-time size calculation and competitive comparison
   * Security stack indicators (post-quantum + classical crypto)
   * Base image selection (Distroless, Alpine, Scratch)
   * Export to .tar.gz with triple cryptographic signatures
   * 14.6 MB minimal image achieved (vs 60MB Alpine)

4. **Settings**
   * Defaults and preferences
   * Runtime selection (Podman/Docker/nerdctl)
   * Accessibility options
   * Smart defaults (hyperpolymath best practices)

=== Security Features

* **Attack Surface Analyzer** - Real-time security scoring (game-like stats!)
* **miniKanren Engine** - Deterministic vulnerability detection (no AI hallucinations!)
* **OWASP ModSecurity CRS** - Web application firewall (Paranoia Level 3)
* **Ephemeral Pinholes** - Temporary firewall openings with auto-expiry (30s to 24h)
* **CVE Integration** - Daily updates from NIST NVD
* **Gap Analysis** - Shows problems *before* deployment
* **OWASP Top 10 Compliance** - Built-in rule checking
* **CIS Benchmarks** - Industry standards
* **Provenance Chains** - Full audit trail (why something is flagged)

=== Database & Documentation

* **VeriSimDB** - Multi-modal storage (graph, vector, tensor, semantic, document, temporal)
* **A2ML** - Attested Markup Language for verified documentation (lax â†’ checked â†’ attested)
* **K9-SVC** - Self-validating component configurations (Kennel â†’ Yard â†’ Hunt security levels)
* **Rekor Integration** - Signature verification via transparency log

=== Game-Like UX

Like customizing a spaceship in a game:

* âœ… Real-time security score (Security: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 67/100)
* âœ… Visual stat bars (Performance, Reliability, Compliance)
* âœ… Impact indicators (â¬†ï¸ Security +15 points)
* âœ… Color-coded risk levels (ğŸ”´ Critical, ğŸŸ  High, ğŸŸ¡ Medium, âœ… Safe)
* âœ… One-click auto-fix for vulnerabilities
* âœ… Simulation mode (test before deploying!)

== Tech Stack

[cols="1,2"]
|===
| Layer | Technology

| **Frontend**
| ReScript-TEA (The Elm Architecture) + Deno

| **Backend**
| Elixir (Phoenix) + GraphQL (Absinthe)

| **Security Reasoning**
| miniKanren (Guile Scheme) + OWASP Rules

| **Database**
| VeriSimDB (6 modalities: graph, vector, tensor, semantic, document, temporal)

| **Documentation**
| A2ML (Attested Markup Language) with Idris2 backend

| **Config Validation**
| K9-SVC (Nickel contracts)

| **Validation**
| Idris2 proofs + Ephapax linear types

| **Firewall**
| firewalld/nftables + ephemeral pinholes

| **WAF**
| OWASP ModSecurity Core Rule Set v4.0

| **Auth**
| PAM (system user verification)

| **Signature Verification**
| Rekor transparency log
|===

== Architecture

=== The Elm Architecture (TEA)

All state transitions are **pure functions**:

[source,rescript]
----
type model = { /* app state */ }
type msg = AddComponent | DragMove | Deploy | Simulate | ...
let update: (model, msg) => (model, effect<msg>)
let view: model => React.element
----

Time-travel debugging. Fully testable. Predictable.

=== Security Reasoning (miniKanren)

Deterministic logic programming for security analysis:

[source,scheme]
----
(define (expose-ssh-to-interneto component)
  "Rule: SSH port 22 must not be exposed to internet"
  (fresh (port interface)
    (exposed-porto component port interface)
    (== port 22)
    (== interface 'public)))

;; Query violations
(run* (component)
  (expose-ssh-to-interneto component))
;; => (nginx-1 svalinn-1)  ; VIOLATIONS!
----

**Why miniKanren, not an SLM?**

* âœ… Deterministic (same input â†’ same output)
* âœ… Explainable (full provenance chain)
* âœ… Instantly updateable (new CVEs added immediately)
* âœ… No hallucinations (can't invent fake CVEs)
* âœ… Fast (milliseconds, not seconds)
* âœ… Small (< 10 MB, no GPU needed)

=== Ephemeral Pinholes (Elixir)

Temporary firewall openings with auto-expiry:

[source,elixir]
----
# Open port 8080 for 5 minutes
{:ok, pinhole_id} = EphemeralPinhole.open(8080, 300)

# Auto-closes after 300 seconds
# Audit logged to VeriSimDB
# Can manually close early
:ok = EphemeralPinhole.close(pinhole_id)
----

=== Multi-Modal Database (VeriSimDB)

[source,elixir]
----
# Store stack with multiple modalities
VeriSim.insert(%{
  uuid: "stack-abc123",
  modalities: [:graph, :semantic, :temporal],
  data: %{
    graph: {"stack:abc123", "stapeln:hasComponent", "comp:nginx"},
    semantic: "<http://example.org/stack/abc123> rdf:type stapeln:Stack",
    temporal: %{timestamp: DateTime.utc_now(), event: "created"}
  }
})

# Query with SPARQL
VeriSim.sparql_query("""
  SELECT ?component WHERE {
    ?stack stapeln:hasComponent ?component .
    ?component stapeln:exposesPort 22 .
  }
""")
----

== Quick Start

=== Prerequisites

* Deno 2.0+
* Guile Scheme 3.0+ (for miniKanren)
* Elixir 1.17+ / Erlang 27+
* firewalld or nftables
* Podman or Docker
* VeriSimDB (optional: federated or standalone)

=== Installation

[source,bash]
----
# Clone repository
git clone https://github.com/hyperpolymath/stapeln.git
cd stapeln

# Frontend setup (Deno, no npm!)
cd frontend
deno install --allow-read --allow-write --allow-env --allow-run -n rescript npm:rescript@11
deno task build

# Backend setup (Elixir)
cd backend
mix deps.get
mix ecto.setup

# Security engine setup (miniKanren)
cd security-rules
guile -s setup.scm

# Firewall setup
sudo ./setup-firewall.sh

# Start all services
./dev.sh
----

=== First Run

. Open browser: http://localhost:8000
. Login with your system user credentials (PAM authentication)
. Drag nginx from palette to canvas
. Configure ports with visual toggles (no CLI!)
. See real-time security scoring
. Click **[Simulate]** to test with packet animation
. Click **[Deploy]** when ready

== Usage

=== Page 1: Paragon View

Vertical stack visualization:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ Cerro Torre (Build)      â”ƒ  âœ… Active
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Svalinn (Gateway)        â”‚  âš ï¸  Port 22 exposed
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ nginx (Web Server)       â”‚  âœ… Healthy
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ postgres (Database)      â”‚  âŒ No backup volume
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Supply Chain             â•‘  âœ… Verified
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Gap Analysis Sidebar**:
* âŒ CRITICAL: SSH port 22 exposed
* âš ï¸  HIGH: No backup volume
* ğŸ’¡ RECOMMENDATION: Add health checks

=== Page 2: Cisco View

Network topology with drag-and-drop:

```
     Internet â˜ï¸
         â”‚
         â–¼
  â”â”â”â”â”â”â”â”â”â”â”â”â”“
  â”ƒ Firewall  â”ƒ ğŸ”¥
  â”—â”â”â”â”â”â”â”â”â”â”â”â”›
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  nginx    â”‚ ğŸŒ
  â”‚  :80 ğŸ”“   â”‚ âš ï¸  Insecure!
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ postgres  â”‚ ğŸ—„ï¸
  â”‚ :5432 ğŸ”’  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Configuration Panel**:
* Port 80: â—‹ Closed â— Open â—‹ Ephemeral
* Security Score: ğŸŸ¡ 67/100
* [Auto-Fix Issues] [Simulate] [Deploy]

=== Page 3: Settings

* Default Runtime: Podman / Docker / nerdctl
* Auto-verify Signatures: âœ…
* Require SBOM: âœ…
* Default CPU Limit: 1 core
* Theme: System / Light / Dark

== Security

stapeln implements **defense-in-depth**:

=== Layers

1. **OWASP ModSecurity CRS** - WAF at gateway (Paranoia Level 3)
2. **firewalld default-deny** - Whitelist-only
3. **miniKanren reasoning** - Deterministic vulnerability detection
4. **CVE daily sync** - NIST NVD integration
5. **Ephemeral pinholes** - Temporary, auto-expiring firewall rules
6. **PAM authentication** - System user verification
7. **Audit logging** - VeriSimDB temporal modality
8. **Signature verification** - Rekor transparency log
9. **SBOM enforcement** - Supply chain verification
10. **Gap analysis** - Pre-deployment security checks

=== Current Compliance

[cols="1,1,1"]
|===
| Standard | Status | Score

| **OWASP Top 10 2021**
| ğŸŸ¡ Partial
| 6/10 (â†’ 10/10 by v1.0)

| **CIS Benchmarks**
| ğŸŸ  In Progress
| 12/20 (â†’ 20/20 by v1.0)

| **NIST Cybersecurity**
| ğŸŸ  In Progress
| 8/15 (â†’ 15/15 by v1.0)

| **WCAG 2.3 AAA**
| âœ… Complete
| 100%

| **OpenSSF Scorecard**
| âœ… Complete
| 100%

| **Post-Quantum Crypto**
| âŒ Pending
| 0% (â†’ 100% by v1.0)
|===

**Target**: 100% across all standards before 1.0 release

=== Post-Quantum Crypto (Roadmap)

Planned upgrades:

* Dilithium5-AES (ML-DSA-87) for signatures
* Kyber-1024 (ML-KEM-1024) for key exchange
* Ed448 + Dilithium5 hybrid mode
* SPHINCS+ as backup
* HTTP/3 + QUIC migration
* SHAKE3-512 hashing

== Accessibility

stapeln is **WCAG 2.3 AAA compliant**:

* âœ… Full keyboard navigation (no mouse required)
* âœ… Screen reader optimized (NVDA, JAWS, Orca tested)
* âœ… Braille display annotations
* âœ… Semantic XML + ARIA labels
* âœ… 7:1 contrast ratio (21:1 for critical elements)
* âœ… Reduced motion support
* âœ… System-aware dark/light mode
* âœ… Captions and transcripts for media

== Roadmap

See link:ROADMAP.md[ROADMAP.md] for detailed timeline.

=== Phase 1: Design (Complete) âœ…

* âœ… ReScript-TEA architecture
* âœ… Three-page UI design
* âœ… Security specifications
* âœ… Database integration specs
* âœ… Game-like UI mockups
* âœ… miniKanren reasoning engine design

=== Phase 2: Frontend Implementation (45%) âš ï¸

* âœ… Model, Msg, Update, View (ReScript)
* âœ… CiscoView, Settings pages
* âœ… LagoGreyImageDesigner component (921 lines)
* âœ… Interactive ice formation designer with real-time sizing
* âœ… Four-page navigation integrated
* âš ï¸ Wire existing views to App.res (immediate)
* âš ï¸ Import/export for designs and images (critical)
* âš ï¸ Build pipeline (podman integration)
* âš ï¸ Attack surface analyzer UI
* âš ï¸ Port configuration panel
* âš ï¸ Security inspector component
* âš ï¸ Simulation mode with packet animation
* âš ï¸ Gap analysis sidebar
* âš ï¸ Auth flow (PAM login)

=== Phase 3: Backend & Security (20%) âš ï¸

* âŒ miniKanren security engine
* âš ï¸ Elixir Phoenix + GraphQL (MVP endpoints live, production hardening pending)
* âŒ Ephemeral pinhole GenServer
* âŒ VeriSimDB integration
* âŒ A2ML parser
* âŒ K9-SVC validator
* âŒ ModSecurity configuration
* âŒ firewalld rules

=== Phase 4: Post-Quantum Crypto (0%) âŒ

* âŒ Dilithium5 signatures
* âŒ Kyber-1024 key exchange
* âŒ HTTP/3 + QUIC migration
* âŒ SPHINCS+ backup
* âŒ SHAKE3-512 hashing

== Documentation

* link:UX-MANIFESTO.md[UX Manifesto] - Design philosophy
* link:CONTAINER-HATER-TEST.md[Container-Hater Test] - Ultimate UX challenge
* link:SECURITY-STACK-AUDIT.md[Security Audit] - Current compliance (47% â†’ 100%)
* link:FIREWALL-CONFIG.md[Firewall Config] - OWASP ModSecurity + ephemeral pinholes
* link:SECURITY-REASONING-ENGINE.md[Security Engine] - miniKanren vs SLM comparison
* link:DATABASE-AND-DOCS-INTEGRATION.md[Database Integration] - VeriSimDB + A2ML + K9-SVC
* link:UI-MOCKUPS.md[UI Mockups] - Game-like interface designs
* link:SETUP.md[Setup Guide] - Deno-only installation
* link:STATE.scm[STATE.scm] - Current project state
* link:ECOSYSTEM.scm[ECOSYSTEM.scm] - Ecosystem position
* link:META.scm[META.scm] - Architecture decisions (14 ADRs)

== Contributing

See link:CONTRIBUTING.md[CONTRIBUTING.md]

**Areas needing help:**

1. miniKanren security rules (Scheme)
2. ReScript UI components
3. Elixir backend (Phoenix)
4. Accessibility testing
5. Documentation
6. Security auditing

== License

https://codeofconduct.club/palimpsest-license/[PMPL-1.0-or-later] (Palimpsest License)

== Related Projects

* https://github.com/hyperpolymath/cerro-torre[cerro-torre] - Container builder
* https://github.com/hyperpolymath/lago-grey[lago-grey] - Base image designer (Alpine/Chainguard alternative)
* https://github.com/hyperpolymath/svalinn[svalinn] - Edge gateway
* https://github.com/hyperpolymath/selur[selur] - IPC bridge
* https://github.com/hyperpolymath/vordr[vÃ¶rÃ°r] - Container runtime
* https://github.com/hyperpolymath/verisimdb[verisimdb] - Multi-modal database
* https://github.com/hyperpolymath/a2ml[a2ml] - Attested Markup Language
* https://github.com/hyperpolymath/k9-svc[k9-svc] - Self-validating configs
* https://github.com/hyperpolymath/selur-compose[selur-compose] - CLI orchestration
* https://github.com/hyperpolymath/verified-container-spec[verified-container-spec] - Protocol specification

== Credits

Created by https://github.com/hyperpolymath[hyperpolymath]

Designed to convert container-haters into container-users. ğŸ¯

**Special thanks** to the test user: A government cyberwar officer who *loathes* containerization. If he can use stapeln successfully, anyone can.

---

_Built with â¤ï¸  and formal verification_


== Architecture

See link:TOPOLOGY.md[TOPOLOGY.md] for a visual architecture map and completion dashboard.
